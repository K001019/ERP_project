{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}تعديل أمر مبيع{% else %}إنشاء أمر مبيع جديد{% endif %}{% endblock %}

{% block page_title %}
{% if form.instance.pk %}
تعديل أمر مبيع رقم #{{ order.id }}
{% else %}
إنشاء أمر مبيع جديد
{% endif %}
{% endblock %}
{% block content %}

<form method="post" id="order-form">
    {% csrf_token %}
    <div class="card">
        <div class="card-header">
            معلومات الطلب الأساسية
        </div>
        <div class="card-body">
            <!-- عرض أخطاء النموذج الرئيسية (مثل خطأ المخزون) -->
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                <p>{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}
            <div class="row">
                <div class="col-md-6">{{ form.customer|as_crispy_field }}</div>
                <div class="col-md-6">{{ form.status|as_crispy_field }}</div>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            بنود الطلب
        </div>
        <div class="card-body">
            {{ formset.management_form }}
            {% if formset.non_form_errors %}
            <div class="alert alert-danger">
                {% for error in formset.non_form_errors %}
                <span>{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- عناوين الأعمدة -->
            <div class="row fw-bold border-bottom pb-2 mb-2 d-none d-md-flex">
                <div class="col-md-5">المنتج</div>
                <div class="col-md-3">سعر الوحدة</div>
                <div class="col-md-2">الكمية</div>
                <div class="col-md-2">الإجراءات</div>
            </div>

            <div id="item-forms-container">
                {% for item_form in formset %}
                <div class="row item-form mb-3 border-bottom pb-3 align-items-center">
                    {{ item_form.id }}
                    <div class="col-md-5">{{ item_form.product|as_crispy_field }}</div>
                    <div class="col-md-3">
                        <label class="d-md-none">سعر الوحدة</label>
                        <p class="form-control-static price-display fw-bold">--</p>
                    </div>
                    <div class="col-md-2">{{ item_form.quantity|as_crispy_field }}</div>
                    <div class="col-md-2">
                        {% if item_form.instance.pk %}
                        {{ item_form.DELETE|as_crispy_field }}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- هذا هو القالب الذي سنستخدمه لإضافة صفوف جديدة بالجافاسكريبت -->
            <div id="empty-form-template" class="d-none">
                <div class="row item-form mb-3 border-bottom pb-3 align-items-center">
                    {{ formset.empty_form.id }}
                    <div class="col-md-5">{{ formset.empty_form.product|as_crispy_field }}</div>
                    <div class="col-md-3">
                        <label class="d-md-none">سعر الوحدة</label>
                        <p class="form-control-static price-display fw-bold">--</p>
                    </div>
                    <div class="col-md-2">{{ formset.empty_form.quantity|as_crispy_field }}</div>
                    <div class="col-md-2">
                         <button type="button" class="btn btn-danger remove-form-btn w-100">إزالة</button>
                    </div>
                </div>
            </div>

            <button type="button" id="add-form-btn" class="btn btn-secondary mt-2">إضافة منتج آخر</button>
        </div>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-success">
            {% if form.instance.pk %}حفظ التغييرات{% else %}إنشاء أمر المبيع{% endif %}
        </button> <a href="{% url 'sales_order_list' %}" class="btn btn-secondary">إلغاء</a>
    </div>
</form>

{% endblock %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const addFormBtn = document.getElementById('add-form-btn');
    const formContainer = document.getElementById('item-forms-container');
    const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
    const totalFormsInput = document.querySelector('#id_items-TOTAL_FORMS');

    addFormBtn.addEventListener('click', function () {
        let currentFormCount = parseInt(totalFormsInput.value);
        let newFormHtml = emptyFormTemplate.replace(/__prefix__/g, currentFormCount);
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml;
        const newForm = tempDiv.firstElementChild;
        formContainer.appendChild(newForm);

        totalFormsInput.value = currentFormCount + 1;
    });

    formContainer.addEventListener('click', function (event) {
        if (event.target && event.target.classList.contains('remove-form-btn')) {
            event.target.closest('.item-form').remove();
        }
    });

    // --- الكود الجديد لجلب السعر ---
    async function fetchProductPrice(productId, priceDisplayElement) {
        if (!productId) {
            priceDisplayElement.textContent = '--';
            return;
        }
        try {
            // انتبه: تأكد من أن الرابط صحيح ويتطابق مع ما في urls.py
            const response = await fetch(`/sales/api/get-product-price/${productId}/`);
            if (!response.ok) {
                throw new Error('Network response error');
            }
            const data = await response.json();
            if (data.price !== undefined) {
                priceDisplayElement.textContent = data.price;
            } else {
                 priceDisplayElement.textContent = 'خطأ';
            }
        } catch (error) {
            console.error('Error fetching price:', error);
            priceDisplayElement.textContent = 'خطأ';
        }
    }

    formContainer.addEventListener('change', function (event) {
        // إذا كان العنصر الذي تغير هو حقل اختيار المنتج
        if (event.target && event.target.classList.contains('product-select')) {
            const productId = event.target.value;
            const formRow = event.target.closest('.item-form');
            const priceDisplay = formRow.querySelector('.price-display');
            fetchProductPrice(productId, priceDisplay);
        }
    });

    // --- تشغيل الكود لأول مرة عند تحميل الصفحة للحقول الموجودة مسبقًا ---
    document.querySelectorAll('.product-select').forEach(selectElement => {
        const productId = selectElement.value;
        const formRow = selectElement.closest('.item-form');
        const priceDisplay = formRow.querySelector('.price-display');
        fetchProductPrice(productId, priceDisplay);
    });

});
</script>
{% endblock %}